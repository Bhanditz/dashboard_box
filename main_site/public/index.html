<!DOCTYPE html>
<html>
<head>
  <title>Flutter Dashboard</title>
  <link href='https://fonts.googleapis.com/css?family=Roboto:300' rel='stylesheet' type='text/css'>
  <style>
    body {
      background: #eee;
      font: 18px Roboto, sans-serif;
      color: #333;
    }

    #container {  
      margin: 20px;
      display: flex;
      flex-flow: row wrap;
      justify-content: space-around;
      align-content: space-around;
    }

    .card {
      margin: 10px;
      width: 450px;
      background: #f7f7f7;
      padding: 20px;
    }

    h3 {
      text-align: center;
      margin: 0;
      margin-bottom: 1em;
      font-size: 1.5em;
    }
  </style>

  <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>

  <script>
  (function(w,d,s,g,js,fjs){
    g=w.gapi||(w.gapi={});g.analytics={q:[],ready:function(cb){this.q.push(cb)}};
    js=d.createElement(s);fjs=d.getElementsByTagName(s)[0];
    js.src='https://apis.google.com/js/platform.js';
    fjs.parentNode.insertBefore(js,fjs);js.onload=function(){g.load('analytics')};
  }(window,document,'script'));
  </script>
</head>
<body>

<div id="container">
  <div class="card">
    <h3>7DA: <span id="num-7da"></span></h3>
    <section id="timeline"></section>
  </div>
</div>

<section id="auth-button"></section>
<button id="firebase-login">Firebase Login</button>
<button id="firebase-logout">Firebase Logout</button>

<script>
gapi.analytics.ready(function() {

  var CLIENT_ID = '308150028417-ftb1c29on9s56ans77e1ani24a8b6m10.apps.googleusercontent.com';

  gapi.analytics.auth.authorize({
    container: 'auth-button',
    clientid: CLIENT_ID,
  });

  var viewSelector = new gapi.analytics.ViewSelector({
    container: 'view-selector'
  });

  var timeline = new gapi.analytics.googleCharts.DataChart({
    reportType: 'ga',
    query: {
      'dimensions': 'ga:date',
      'metrics': 'ga:7dayUsers',
      'start-date': '30daysAgo',
      'end-date': 'yesterday',
      'ids': 'ga:120928408'
    },
    chart: {
      type: 'LINE',
      container: 'timeline'
    }
  });

  timeline.on('success', function(response) {
    var rows = response.data.rows;
    var lastActiveUserCount = rows[rows.length-1]['c'][1]['v'];
    document.getElementById('num-7da').innerHTML = lastActiveUserCount;
  });

  timeline.execute();

});
</script>

<template id="flutter_analyze_flutter_repo_tmpl">
  <div class="card">
    <h3 class="title">Analyze Repo: <span class="percent"></span>% within goal</h3>
    <section class="content">
      <div>Current time: <span class="current_time"></span> sec</div>
      <div>Target time: <span class="target_time"></span> sec</div>
    </section>
  </div>
</template>

<script>
var ref = new Firebase("https://purple-butterfly-3000.firebaseio.com/");
ref.onAuth(authDataCallback);

function authDataCallback(authData) {
  if (authData) {
    console.log("User " + authData.uid + " is logged in with " +
      authData.provider + " and has displayName '" +
      authData.google.displayName + "' and email " + authData.google.email);
    // save the user's profile into the database so we can
    // use them in Security and Firebase Rules
    ref.child("users").child(authData.uid).set({
      provider: authData.provider,
      name: authData.google.displayName,
      email: authData.google.email || 'undefined'
    }).then(function(snapshot) {
      getData();
    }, function(error) {
      console.error(error);
    });
  } else {
    console.log("User is logged out");
  }
}

function authHandler(error, authData) {
  if (error) {
    console.log("Login Failed!", error);
  } else {
    console.log("Authenticated successfully with payload:", authData);
  }
}

function getData() {
  ref.child('measurements').on("value", function(snapshot) {
    console.log(snapshot.val());
    generateBoxes(snapshot.val());
  }, function (errorObject) {
    console.log("The read failed: " + errorObject.code);
  });
}

var generators = {
  'flutter_analyze_flutter_repo': function(key, data) {
    var tmpl = document.querySelector('#' + key + '_tmpl');
    var clone = document.importNode(tmpl.content, true);
    clone.querySelector('.percent').textContent = Math.round((data['Target Time'] / data['Analysis Time']) * 100);
    clone.querySelector('.current_time').textContent = data['Analysis Time'];
    clone.querySelector('.target_time').textContent = data['Target Time'];
    return document.querySelector('#container').appendChild(clone);
  }
};

function generateBoxes(measurements) {
  for (var key in measurements) {
    if (measurements.hasOwnProperty(key)) {
      var generator = generators[key];
      if (generator === undefined) {
        console.error('Did not find generator for ' + key);
        continue;
      }
      generator(key, measurements[key]);
    }
  }
}

document.getElementById('firebase-login').addEventListener('click', function() {
  ref.authWithOAuthPopup("google", authHandler, {'scope': "email"});
});

document.getElementById('firebase-logout').addEventListener('click', function() {
  console.log('Logging out');
  ref.unauth();
});

</script>
</body>
</html>